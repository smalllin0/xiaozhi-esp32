#ifndef ES8311_AUDIO_CODEC_H_
#define ES8311_AUDIO_CODEC_H_

#include "audio_codec.h"
#include "esp_codec_dev.h"
#include "audio_codec_ctrl_if.h"
#include "audio_codec_gpio_if.h"
#include <driver/i2c_master.h>
#include <driver/gpio.h>
#include <mutex>

class Es8311AudioCodec : public AudioCodec {
public:
    Es8311AudioCodec(void* i2c_master_handle,
                    i2c_port_t i2c_port,
                    int input_sample_rate,
                    int output_sample_rate,
                    gpio_num_t mclk, gpio_num_t bclk, gpio_num_t ws, gpio_num_t dout, gpio_num_t din,
                    gpio_num_t pa_pin, uint8_t es8311_addr, bool use_mclk=true, bool pa_inverted=false);
    ~Es8311AudioCodec();

    virtual void SetOutputVolume(int volume) override;
    virtual void EnableInput(bool enable) override;
    virtual void EnableOutput(bool enable) override;

private:
    void CreateDuplexChannels(gpio_num_t mclk, gpio_num_t bclk, gpio_num_t ws, gpio_num_t dout, gpio_num_t din);
    void UpdateDeviceState();
    virtual int Read(int16_t* dst, int samples) override;
    virtual int Write(const int16_t* data, int samples) override;

    const audio_codec_data_if_t*    data_if_{nullptr};  // 通用接口抽象：屏蔽I2S PDM/TDM
    const audio_codec_ctrl_if_t*    ctrl_if_{nullptr};  // 通用接口抽象：屏蔽具体的接口（I2S或SPI）
    const audio_codec_gpio_if_t*    gpio_if_{nullptr};  // 通用接口抽象：屏蔽GPIO编号/平台
    const audio_codec_if_t*         codec_if_{nullptr}; // 专用设备驱动层：对编解码器控制操作进行抽象
    esp_codec_dev_handle_t          dev_{nullptr};      // 统一设备层抽象

    gpio_num_t              pa_pin_{GPIO_NUM_NC};
    bool                    pa_inverted_{false};
    std::mutex              data_if_mutex_;
};

#endif // !ES8311_AUDIO_CODEC_H_