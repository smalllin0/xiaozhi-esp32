# 小智工作拆解

1. 设置工作状态：启动中
2. 初始化显示器件
3. 初始化编码器
    1. 获取器件抽象
    2. 初始化音频服务
    3. 启动音频服务
    4. 设置音频服务回调
        1. 发送队列可用回调
        2. 唤醒词检测回调
        3. VAD改变
5. 启动状态显示更新定时器
6. 启动网络
7. 显示状态更新（网络图标）
8. 获取OTA实例，检查更新
    1. 设置工作状态：激活状态
    2. 更新显示：检查新版本
        1. 获取板级描述：json
        2. 有json描述时，设置方法为POST，否则为GET
        3. 设置内容类型：json
        4. 使用http对象以指定方法打开指定连接，并检查状态码
        5. 获取http返回的消息
        - 更新
        - **注，这里会给出连接所需的地址等信息**
    3. 给当前版本打上有效的标签
    4. 检查激活情况
9. 获取MCP服务实例
  1. 添加共同工具
  2. 添加用户个人工具
10. 初始化协议
  - 根据ota接收结果，初始化为Mqtt/websocket，默认为mqtt
  - 设置协议勾子函数
    1. 连接时勾子函数
    2. 网络错误勾子
    3. 音频数据到达勾子
    4. 音频通道打开勾子
    5. 音频通道关闭勾子
    6. JSON数据到达
    7. 启动协议
11. 设置工作状态：空闲

## xiaozhi返回的信息

{"mqtt":{"endpoint":"mqtt.xiaozhi.me","client_id":"GID_test@@@4c_44_5b_8f_33_d3@@@f4b8c9d0-1234-5678-90ab-cdef12345678","username":"eyJpcCI6IjExMi4yMjQuMjA1LjIwNiJ9","password":"udr5g50spWxH238hb5+N+mXaobgBty2DZlCIU3KtKwY=","publish_topic":"device-server","subscribe_topic":"null"},"websocket":{"url":"wss://api.tenclass.net/xiaozhi/v1/","token":"test-token"},"server_time":{"timestamp":1765099115131,"timezone_offset":480},"firmware":{"version":"1.3.0","url":""},"activation":{"code":"687965","message":"xiaozhi.me\n687965","challenge":"71366da1-1beb-4b98-94c0-5d6c7114af88"}}%     


## curl使用

```bash
curl -X POST \
     -H "Activation-Version: 1" \
     -H "Device-Id: 4c:44:5b:8f:33:d3" \
     -H "Client-Id: f4b8c9d0-1234-5678-90ab-cdef12345678" \
     -H "User-Agent: my_esp32c3-core_adapter/1.8" \
     -H "Accept-Language: zh-CN" \
     -H "Content-Type: application/json" \
     -d '{
  "version": 2,
  "language": "zh-CN",
  "flash_size": 4194304,
  "minimum_free_heap_size": "187632",
  "mac_address": "a8:03:2a:55:66:77",
  "uuid": "f4b8c9d0-1234-5678-90ab-cdef12345678",
  "chip_model_name": "esp32c3",
  "chip_info": {
    "model": 9,
    "cores": 1,
    "revision": 3,
    "features": 1
  },
  "application": {
    "name": "xiaozhi-ai",
    "version": "1.3.0",
    "compile_time": "2025-12-07T17:08:00Z",
    "idf_version": "v5.3.1",
    "elf_sha256": "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855"
  },
  "partition_table": [
    {
      "label": "nvs",
      "type": 1,
      "subtype": 2,
      "address": 98304,
      "size": 24576
    },
    {
      "label": "otadata",
      "type": 1,
      "subtype": 0,
      "address": 122880,
      "size": 8192
    },
    {
      "label": "phy_init",
      "type": 1,
      "subtype": 1,
      "address": 131072,
      "size": 4096
    },
    {
      "label": "app0",
      "type": 0,
      "subtype": 16,
      "address": 135168,
      "size": 2097152
    }
  ],
  "ota": {
    "label": "app0"
  },
  "display": {
    "monochrome": false,
    "width": 240,
    "height": 240
  },
  "board": {
    "name": "my_esp32c3-core_adapter",
    "has_microphone": true,
    "has_speaker": true,
    "power_save_enabled": true
  }
}'\
     https://api.tenclass.net/xiaozhi/ota/
```
- -X：指定HTTP的方法
- -H：添加请求头（可多次使用）
- -d：指定请求体（POST/PUT等的数据）

